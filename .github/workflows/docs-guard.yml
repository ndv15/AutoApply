name: Documentation Guards

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - 'docs/**'

jobs:
  # Gate 1: Path Guard - Block changes outside allowed paths
  path-guard:
    name: "Path Guard"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect disallowed changes
        id: changes
        run: |
          # Fetch base branch for comparison
          git fetch origin ${{ github.base_ref || 'main' }}
          
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref || 'main' }} HEAD)
          
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # Check if any files are outside allowed paths
          DISALLOWED=""
          while IFS= read -r file; do
            if [[ ! "$file" =~ ^(docs/|\.github/workflows/|tests/fixtures/) ]]; then
              DISALLOWED="$DISALLOWED$file"$'\n'
            fi
          done <<< "$CHANGED_FILES"
          
          if [ -n "$DISALLOWED" ]; then
            echo "::error::Files changed outside allowed paths (docs/, .github/workflows/, tests/fixtures/)"
            echo "Disallowed changes:"
            echo "$DISALLOWED"
            exit 1
          fi
          
          echo "âœ… All changes are within allowed paths"

  # Gate 2: Secrets/PII Scan
  secret-scan:
    name: "Secret Scan"
    runs-on: ubuntu-latest
    needs: path-guard
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan for secrets in docs
        run: |
          echo "Scanning docs/ for secrets and PII..."
          
          # Check for API keys
          if grep -rE "(api[_-]?key|apikey|api[_-]?secret)" docs/ --include="*.md" --include="*.txt" 2>/dev/null; then
            echo "::error::API keys found in documentation"
            exit 1
          fi
          
          # Check for access tokens
          if grep -rE "(access[_-]?token|bearer[_-]?token|auth[_-]?token)" docs/ --include="*.md" --include="*.txt" 2>/dev/null; then
            echo "::error::Access tokens found in documentation"
            exit 1
          fi
          
          # Check for hardcoded passwords
          if grep -rE "(password|passwd|pwd)[[:space:]]*[:=][[:space:]]*['\"]?[a-zA-Z0-9]{8,}" docs/ --include="*.md" --include="*.txt" 2>/dev/null; then
            echo "::error::Hardcoded passwords found in documentation"
            exit 1
          fi
          
          # Check for real email addresses (allow examples)
          if grep -rE "[a-zA-Z0-9._%+-]+@(?!example\.com|test\.com|sample\.com|autoapply\.ai)[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}" docs/ --include="*.md" --include="*.txt" 2>/dev/null; then
            echo "::warning::Real email addresses found in documentation (use example.com)"
          fi
          
          echo "âœ… No secrets or PII detected in documentation"

  # Gate 3: Output Verification - Check AMOT/metrics present
  output-verification:
    name: "Output Verification"
    runs-on: ubuntu-latest
    needs: path-guard
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify AMOT/metrics present in explainer
        run: |
          echo "Checking for AMOT and metrics mentions..."
          
          if ! grep -iq 'AMOT' docs/product_explainer_v1.md; then
            echo "::error::Missing AMOT mention in product explainer"
            exit 1
          fi
          
          if ! grep -iq 'metrics' docs/product_explainer_v1.md; then
            echo "::error::Missing metrics mention in product explainer"
            exit 1
          fi
          
          echo "âœ… AMOT and metrics references found"

  # Gate 4: Performance Time Budget - Pandoc export test
  performance-gate:
    name: "Performance Gate"
    runs-on: ubuntu-latest
    needs: path-guard
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc

      - name: Test export performance (under 60s)
        run: |
          echo "Testing Pandoc export time..."
          
          START=$(date +%s)
          timeout 60s pandoc docs/product_explainer_v1.md --from gfm --to html -o /tmp/test_export.html || {
            echo "::error::Export exceeded 60s time budget or failed"
            exit 1
          }
          END=$(date +%s)
          DURATION=$((END - START))
          
          echo "âœ… Export completed in ${DURATION} seconds (within 60s budget)"

  # Summary Gate - All checks passed
  all-guards-passed:
    name: "âœ… All Guards Passed"
    runs-on: ubuntu-latest
    needs: [path-guard, secret-scan, output-verification, performance-gate]
    steps:
      - name: Summary
        run: |
          echo "ðŸŽ‰ All documentation guards passed!"
          echo "âœ… Path guard: Changes limited to allowed paths"
          echo "âœ… Secret scan: No credentials or PII found"
          echo "âœ… Output verification: AMOT/metrics present"
          echo "âœ… Performance gate: Export within time budget"
